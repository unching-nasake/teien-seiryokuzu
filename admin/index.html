<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>勢力図ゲーム管理画面</title>
    <link rel="stylesheet" href="admin.css" />
  </head>
  <body>
    <!-- ログインモーダル -->
    <div id="loginModal">
      <form
        class="modal-content"
        onsubmit="
          event.preventDefault();
          adminLogin();
        "
      >
        <h2>🔐 Admin認証</h2>
        <input
          type="password"
          id="loginPassword"
          placeholder="管理者パスワードを入力"
          autocomplete="current-password"
        />
        <button type="submit">ログイン</button>
        <div id="loginError" class="error-message"></div>
      </form>
    </div>

    <!-- 管理画面メインパネル -->
    <div class="container" id="adminPanel">
      <h1>勢力図ゲーム管理画面</h1>

      <!-- ゲームステータスカード -->
      <div id="statusCard" class="status-card">
        <div class="status-card-header">
          <div class="status-info">
            <span id="statusIcon">🟢</span>
            <span id="statusText">現在: 稼働中</span>
          </div>
          <button id="toggleBtn" onclick="toggleStatus()">
            ゲームを停止する
          </button>
        </div>

        <!-- スケジュール予約機能 -->
        <div id="scheduleSection">
          <div class="schedule-info">
            <span>⏰ 予約実行</span>
            <span id="scheduleStatus">未設定</span>
          </div>
          <div id="scheduleControls">
            <input type="datetime-local" id="scheduleTime" />
            <button id="scheduleBtn" class="btn" onclick="setSchedule()">
              予約する
            </button>
            <button
              id="cancelScheduleBtn"
              class="btn"
              onclick="cancelSchedule()"
            >
              取消
            </button>
          </div>
        </div>
      </div>

      <!-- タブナビゲーション -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('settings')">
          ゲーム設定
        </button>
        <button class="tab-btn" onclick="switchTab('notices')">お知らせ</button>
        <button class="tab-btn" onclick="switchTab('security')">
          セキュリティ
        </button>
        <button class="tab-btn" onclick="switchTab('data')">データ</button>
      </div>

      <!-- [タブ] ゲーム設定 -->
      <div id="settingsTab" class="tab-content active">
        <!-- 庭園モード設定 -->
        <div class="section">
          <h3>🌷 庭園モード</h3>
          <div class="setting-item setting-item-row">
            <input
              type="checkbox"
              id="gardenMode"
              class="checkbox-large"
              onchange="toggleApPostSettings()"
            />
            <label for="gardenMode" class="cursor-pointer"
              >庭園モードを有効にする (掲示板連携機能)</label
            >
          </div>
        </div>

        <!-- AP補充・上限設定 -->
        <div class="section">
          <h3>⚡ AP設定 (毎時05分付与)</h3>
          <div id="gardenApSettings">
            <div class="setting-group">
              <div class="setting-item">
                <label>初期AP (新規登録時)</label>
                <input type="number" id="initialAp" min="0" />
              </div>
            </div>

            <div class="setting-group">
              <div class="setting-item">
                <label>個人AP上限</label>
                <input type="number" id="indLimit" min="0" />
              </div>
              <div class="setting-item">
                <label>共有AP上限係数 (xアクティブ人数)</label>
                <input type="number" id="sharedBase" min="0" />
              </div>
            </div>

            <div class="setting-group">
              <div class="setting-item">
                <label>1投稿あたりのAP</label>
                <input type="number" id="apPerPost" min="0" />
              </div>
              <div class="setting-item">
                <label>投稿補充の上限AP</label>
                <input type="number" id="maxApFromPosts" min="0" />
              </div>
            </div>

            <div class="setting-group">
              <div class="setting-item">
                <label>ランダム補充 (最小〜最大)</label>
                <div class="flex-row-center-gap">
                  <input type="number" id="randomMin" class="w-45" />
                  <span>〜</span>
                  <input type="number" id="randomMax" class="w-45" />
                </div>
              </div>
              <div class="setting-item">
                <label>弱小勢力ボーナス (最小〜最大)</label>
                <div class="flex-row-center-gap">
                  <input type="number" id="bonusMin" class="w-45" />
                  <span>〜</span>
                  <input type="number" id="bonusMax" class="w-45" />
                </div>
              </div>
            </div>

            <div class="setting-group">
              <div class="setting-item">
                <label>庭園🌷AP回復コスト(共有AP)</label>
                <input type="number" id="gardenRefillCost" min="0" />
              </div>
              <div class="setting-item">
                <label>庭園🌷AP回復量(共有AP)</label>
                <input type="number" id="gardenRefillAmount" min="0" />
              </div>
              <div class="setting-item">
                <label>🌷AP回復間隔 (時間)</label>
                <input
                  type="number"
                  id="tulipRefillIntervalHours"
                  min="0"
                  step="0.5"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- ネームドマス設定 -->
        <div class="section">
          <h3>⭐ ネームドマス設定</h3>
          <div class="setting-group">
            <div class="setting-item">
              <label>作成コスト (AP)</label>
              <input type="number" id="namedTileCost" />
            </div>
            <div class="setting-item">
              <label>作成間隔 (時間)</label>
              <input type="number" id="namedTileIntervalHours" />
              <div class="help-text">
                同じ勢力が次に作成できるまでの待機時間
              </div>
            </div>
            <div class="setting-item">
              <label>最大ネームドマス数 (全体上限)</label>
              <input type="number" id="maxNamedTiles" min="0" />
              <div class="help-text">マップ全体のネームドマス数の上限</div>
            </div>
          </div>

          <div class="setting-group">
            <div class="setting-item">
              <label>ZOC攻撃コスト倍率 (通常)</label>
              <input type="number" id="zocMultiplier" step="0.1" />
            </div>
            <div class="setting-item">
              <label>ZOC攻撃コスト倍率 (攻撃側中核)</label>
              <input type="number" id="zocReducedMultiplier" step="0.1" />
              <div class="help-text">
                攻撃側の中核マスがZOC範囲内にある場合の倍率
              </div>
            </div>
            <div class="setting-item">
              <label>陥落時APボーナス (最小〜最大)</label>
              <div class="flex-row-center-gap">
                <input type="number" id="fallApBonusMin" class="w-45" />
                <span>〜</span>
                <input type="number" id="fallApBonusMax" class="w-45" />
              </div>
              <div class="help-text">
                勢力を陥落させたプレイヤーの個人APに付与されます
              </div>
            </div>
          </div>
        </div>

        <!-- 中核マス設定 -->
        <div class="section">
          <h3>🛡️ 中核マス設定</h3>
          <div class="setting-group">
            <div class="setting-item">
              <label>攻撃コスト倍率</label>
              <input type="number" id="coreAttackMultiplier" step="0.1" />
            </div>
            <div class="setting-item">
              <label>即時中核化 閾値 (タイル数)</label>
              <input type="number" id="instantCoreThreshold" />
              <div class="help-text">
                このタイル数以下の勢力は待ち時間なしで即時中核化されます
              </div>
            </div>
            <div class="setting-item">
              <label>中核マス保有上限</label>
              <input type="number" id="maxCoreTiles" />
              <div class="help-text">1勢力が保有できる中核マスの最大数</div>
            </div>
          </div>
        </div>

        <!-- 飛び地制限設定 -->
        <div class="section">
          <h3>🏝️ 飛び地制限設定</h3>
          <div class="setting-group">
            <div class="setting-item">
              <label>飛び地制限距離 (マスの距離)</label>
              <input type="number" id="enclaveDistanceLimit" min="0" />
              <div class="help-text">
                この距離を超える飛び地作成にはペナルティが発生します
              </div>
            </div>
            <div class="setting-item">
              <label>ペナルティ発生単位 (マス数)</label>
              <input type="number" id="enclavePenaltyUnit" min="1" />
              <div class="help-text">
                制限距離を超えた場合、この単位ごとにコストが+1されます
              </div>
            </div>
          </div>
        </div>

        <!-- 併合制限設定 -->
        <div class="section">
          <h3>🚫 併合制限設定</h3>
          <div class="setting-group">
            <div class="setting-item">
              <label>併合禁止ランク (上位N位)</label>
              <input type="number" id="mergerProhibitedRank" min="0" />
              <div class="help-text">
                指定された順位以の勢力は、他の勢力に併合申請（吸収されること）を行えません。
                0の場合は制限なし
              </div>
            </div>
          </div>
        </div>

        <!-- メッセージ送信設定 -->
        <div class="section">
          <h3>✉️ メッセージ送信設定</h3>
          <div class="setting-group">
            <div class="setting-item">
              <label>メッセージ送信コスト (AP)</label>
              <input type="number" id="messageCost" min="0" />
            </div>
          </div>
        </div>

        <!-- 休憩時間設定 -->
        <div class="section">
          <h3>😴 休憩時間設定</h3>
          <div class="setting-item setting-item-row">
            <input
              type="checkbox"
              id="breakTimeEnabled"
              class="checkbox-large"
            />
            <label for="breakTimeEnabled" class="cursor-pointer"
              >休憩時間を有効にする（この間は攻撃行為ができません）</label
            >
          </div>
          <div class="setting-group mt-10">
            <div class="setting-item">
              <label>開始時間</label>
              <input type="time" id="breakStartTime" value="01:00" />
            </div>
            <div class="setting-item">
              <label>終了時間</label>
              <input type="time" id="breakEndTime" value="06:00" />
            </div>
          </div>
        </div>

        <button class="save-btn" onclick="updateSettings()">
          設定を全て保存する
        </button>
      </div>

      <!-- [タブ] お知らせ管理 -->
      <div id="noticesTab" class="tab-content">
        <div class="section">
          <h3>現在のお知らせ</h3>
          <div id="noticeList" class="notice-list">
            <p class="list-empty">読み込み中...</p>
          </div>
        </div>

        <div class="section">
          <h3>お知らせを追加</h3>
          <div class="setting-item mb-10">
            <label>タイトル</label>
            <input type="text" id="noticeTitle" placeholder="重要なお知らせ" />
          </div>
          <div class="setting-item mb-15">
            <label>本文</label>
            <textarea
              id="noticeContent"
              rows="4"
              placeholder="内容を入力してください..."
            ></textarea>
          </div>
          <button class="save-btn bg-primary" onclick="addNotice()">
            📢 お知らせを投稿
          </button>
        </div>
      </div>

      <!-- [タブ] セキュリティ設定 -->
      <div id="securityTab" class="tab-content">
        <!-- パスワード変更 -->
        <form
          class="section"
          onsubmit="
            event.preventDefault();
            changePassword();
          "
        >
          <h3>🔐 管理者パスワード変更</h3>
          <div class="setting-item mb-15">
            <label>現在のパスワード</label>
            <input
              type="password"
              id="currentPassword"
              placeholder="現在のパスワードを入力"
              autocomplete="current-password"
            />
          </div>
          <div class="setting-group">
            <div class="setting-item">
              <label>新しいパスワード</label>
              <input
                type="password"
                id="newPassword"
                placeholder="新しいパスワードを入力"
                autocomplete="new-password"
              />
            </div>
            <div class="setting-item">
              <label>新しいパスワード（確認）</label>
              <input
                type="password"
                id="confirmPassword"
                placeholder="もう一度入力"
                autocomplete="new-password"
              />
            </div>
          </div>
          <button type="submit" class="save-btn">パスワードを更新する</button>
        </form>

        <!-- アカウント作成制限 -->
        <div class="section">
          <h3>👥 アカウント作成制限 (IPベース)</h3>
          <div class="setting-item">
            <label>同一IPでのアカウント作成上限</label>
            <input type="number" id="maxAccountsPerIp" min="1" value="2" />
            <small class="help-text"
              >1つのIPアドレスから作成可能なアカウントの最大数です。</small
            >
          </div>
          <div class="setting-item mt-15">
            <label>制限から除外するIPリスト (改行区切り)</label>
            <textarea
              id="excludedIps"
              rows="5"
              placeholder="127.0.0.1&#10;192.168.1.1"
            ></textarea>
            <small class="help-text"
              >管理者や特定の環境など、制限を適用したくないIPアドレスを入力してください。</small
            >
          </div>
        </div>
        <button class="save-btn" onclick="updateSettings()">
          設定を保存する
        </button>
      </div>

      <!-- [タブ] データ管理 -->
      <div id="dataTab" class="tab-content">
        <!-- マップ画像設定 -->
        <div class="section">
          <h3>🖼️ マップ画像設定</h3>
          <div class="setting-item">
            <label>保存間隔（分）</label>
            <input type="number" id="mapImageInterval" min="1" max="60" />
            <small class="help-text"
              >全体マップ画像を生成・上書き保存する間隔です。</small
            >
          </div>
        </div>

        <!-- 外部連携設定 -->
        <div class="section">
          <h3>🆔 ホストの庭園 ID 設定</h3>
          <div class="setting-item">
            <label>ホスト ID</label>
            <input type="text" id="adminId" placeholder="ホスト IDを入力" />
            <small class="help-text">🌷の送付先</small>
          </div>
        </div>

        <button class="save-btn" onclick="updateSettings()">
          設定を保存する
        </button>

        <!-- 危険な操作 (リセット) -->
        <details class="danger-zone mt-20">
          <summary>Danger Zone</summary>
          <div class="danger-content">
            <p class="danger-desc">
              全てのプレイヤー、勢力、マップデータを完全に削除します。この操作は取り消せません。
            </p>
            <button class="reset-btn" onclick="resetData()">
              全てのデータをリセットする
            </button>
          </div>
        </details>
      </div>

      <div id="feedback"></div>
    </div>

    <script src="admin.js"></script>
  </body>
</html>
