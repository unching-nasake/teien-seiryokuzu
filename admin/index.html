<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å‹¢åŠ›å›³ã‚²ãƒ¼ãƒ ç®¡ç†ç”»é¢</title>
    <style>
      :root {
        --primary-color: #007bff;
        --danger-color: #dc3545;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --bg-color: #f4f7f6;
        --card-bg: #ffffff;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        padding: 20px;
        color: #333;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: var(--card-bg);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }
      h1 {
        margin-top: 0;
        font-size: 24px;
        text-align: center;
        color: #2c3e50;
      }
      /* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆä¸Šéƒ¨å›ºå®šï¼‰ */
      .top-controls {
        background: #e9ecef;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .top-controls label {
        font-weight: bold;
        white-space: nowrap;
      }
      .top-controls input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
      }

      /* ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ï¼ˆé»„è‰²ï¼‰ */
      .status-card {
        background-color: var(--warning-color);
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
      }
      .status-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      #statusText {
        font-size: 1rem;
      }
      #toggleBtn {
        padding: 6px 16px;
        font-size: 0.9rem;
        background: #343a40;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: opacity 0.2s;
      }
      #toggleBtn:hover {
        opacity: 0.8;
      }

      /* ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
      .tabs {
        display: flex;
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 20px;
      }
      .tab-btn {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 1rem;
        font-weight: bold;
        color: #6c757d;
        position: relative;
      }
      .tab-btn.active {
        color: var(--primary-color);
      }
      .tab-btn.active::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background: var(--primary-color);
      }

      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      /* è¨­å®šé …ç›® */
      .section {
        margin-bottom: 25px;
      }
      .section h3 {
        border-left: 4px solid var(--primary-color);
        padding-left: 10px;
        margin-bottom: 15px;
        color: #34495e;
      }
      .setting-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
      }
      .setting-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .setting-item label {
        font-size: 0.9rem;
        font-weight: bold;
        color: #555;
      }
      input[type="number"],
      input[type="text"],
      textarea {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.95rem;
      }

      /* ãƒœã‚¿ãƒ³ */
      .save-btn {
        width: 100%;
        padding: 12px;
        background-color: var(--success-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        margin-top: 10px;
      }
      .save-btn:hover {
        background-color: #218838;
      }

      /* å±é™ºãªæ“ä½œ */
      .danger-zone {
        margin-top: 40px;
        border: 1px solid #ffc9c9;
        border-radius: 8px;
        background-color: #fff5f5;
      }
      .danger-zone summary {
        padding: 10px 15px;
        font-weight: bold;
        color: var(--danger-color);
        cursor: pointer;
        list-style: none;
      }
      .danger-zone summary::before {
        content: "âš ï¸ ";
      }
      .danger-content {
        padding: 15px;
        border-top: 1px solid #ffc9c9;
      }
      .reset-btn {
        background-color: var(--danger-color);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
        font-weight: bold;
      }

      /* ãŠçŸ¥ã‚‰ã›ãƒªã‚¹ãƒˆ */
      .notice-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 20px;
      }
      .notice-item {
        background-color: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }
      .notice-info h4 {
        margin: 0 0 5px 0;
      }
      .notice-date {
        font-size: 0.8rem;
        color: #999;
      }
      .del-notice-btn {
        background: var(--danger-color);
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
      }

      #feedback {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 20px;
        border-radius: 4px;
        color: white;
        display: none;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }
      .feedback-success {
        background-color: var(--success-color);
      }
      .feedback-error {
        background-color: var(--danger-color);
      }

      /* ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« */
      #loginModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      #loginModal .modal-content {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
      }
      #loginModal h2 {
        margin-top: 0;
        text-align: center;
        color: #2c3e50;
      }
      #loginModal input {
        width: 100%;
        padding: 12px;
        margin: 15px 0;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        box-sizing: border-box;
      }
      #loginModal button {
        width: 100%;
        padding: 12px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
      }
      #loginModal button:hover {
        opacity: 0.9;
      }
      #loginModal .error-message {
        color: var(--danger-color);
        font-size: 0.9rem;
        margin-top: 10px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="loginModal" style="display: none">
      <div class="modal-content">
        <h2>ğŸ” Adminèªè¨¼</h2>
        <input
          type="password"
          id="loginPassword"
          placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
          onkeypress="if (event.key === 'Enter') adminLogin();"
        />
        <button onclick="adminLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div id="loginError" class="error-message"></div>
      </div>
    </div>

    <div class="container" id="adminPanel" style="display: none">
      <h1>å‹¢åŠ›å›³ã‚²ãƒ¼ãƒ ç®¡ç†ç”»é¢</h1>

      <!-- ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ -->
      <div
        id="statusCard"
        class="status-card"
        style="flex-direction: column; align-items: stretch; gap: 15px"
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
          "
        >
          <div class="status-info">
            <span id="statusIcon">ğŸŸ¢</span>
            <span id="statusText">ç¾åœ¨: ç¨¼åƒä¸­</span>
          </div>
          <button id="toggleBtn" onclick="toggleStatus()">
            ã‚²ãƒ¼ãƒ ã‚’åœæ­¢ã™ã‚‹
          </button>
        </div>

        <!-- [NEW] ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½ -->
        <div
          id="scheduleSection"
          style="
            background: rgba(0, 0, 0, 0.05);
            padding: 12px;
            border-radius: 6px;
            border: 1px dashed rgba(0, 0, 0, 0.1);
          "
        >
          <div
            style="
              font-size: 0.9rem;
              margin-bottom: 8px;
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <span>â° äºˆç´„å®Ÿè¡Œ</span>
            <span id="scheduleStatus" style="font-weight: normal; color: #444"
              >æœªè¨­å®š</span
            >
          </div>
          <div
            id="scheduleControls"
            style="display: flex; gap: 8px; align-items: center"
          >
            <input
              type="datetime-local"
              id="scheduleTime"
              style="
                flex: 1;
                padding: 6px;
                border-radius: 4px;
                border: 1px solid #ccc;
              "
            />
            <button
              id="scheduleBtn"
              class="btn"
              style="
                padding: 6px 12px;
                font-size: 0.85rem;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
              onclick="setSchedule()"
            >
              äºˆç´„ã™ã‚‹
            </button>
            <button
              id="cancelScheduleBtn"
              class="btn"
              style="
                padding: 6px 12px;
                font-size: 0.85rem;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                display: none;
              "
              onclick="cancelSchedule()"
            >
              å–æ¶ˆ
            </button>
          </div>
        </div>
      </div>

      <!-- ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('settings')">
          ã‚²ãƒ¼ãƒ è¨­å®š
        </button>
        <button class="tab-btn" onclick="switchTab('notices')">
          ãŠçŸ¥ã‚‰ã›ç®¡ç†
        </button>
        <button class="tab-btn" onclick="switchTab('security')">
          ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
        </button>
        <button class="tab-btn" onclick="switchTab('accounts')">
          ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
        </button>
        <button class="tab-btn" onclick="switchTab('others')">ãã®ä»–</button>
      </div>

      <!-- å…¨èˆ¬è¨­å®šã‚¿ãƒ– -->
      <div id="settingsTab" class="tab-content active">
        <div class="section">
          <h3>ğŸŒ· åº­åœ’ãƒ¢ãƒ¼ãƒ‰</h3>
          <div
            class="setting-item"
            style="flex-direction: row; align-items: center; gap: 10px"
          >
            <input
              type="checkbox"
              id="gardenMode"
              onchange="toggleApPostSettings()"
              style="width: 20px; height: 20px; cursor: pointer"
            />
            <label for="gardenMode" style="cursor: pointer"
              >åº­åœ’ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ (æ²ç¤ºæ¿é€£æºæ©Ÿèƒ½)</label
            >
          </div>
        </div>

        <div class="section">
          <h3>âš¡ APè¨­å®š (æ¯æ™‚05åˆ†ä»˜ä¸)</h3>
          <div class="setting-group">
            <div class="setting-item">
              <label>åˆæœŸAP (æ–°è¦ç™»éŒ²æ™‚)</label>
              <input type="number" id="initialAp" min="0" />
            </div>
            <div class="setting-item">
              <label>å€‹äººAPä¸Šé™</label>
              <input type="number" id="indLimit" min="0" />
            </div>
          </div>

          <div id="gardenApSettings">
            <div class="setting-group">
              <div class="setting-item">
                <label>1æŠ•ç¨¿ã‚ãŸã‚Šã®AP</label>
                <input type="number" id="apPerPost" min="0" />
              </div>
              <div class="setting-item">
                <label>æŠ•ç¨¿è£œå……ã®ä¸Šé™AP</label>
                <input type="number" id="maxApFromPosts" min="0" />
              </div>
            </div>
            <div class="setting-group" style="margin-bottom: 15px">
              <div class="setting-item">
                <label>åº­åœ’ğŸŒ·APå›å¾©ã‚³ã‚¹ãƒˆ(å…±æœ‰AP)</label>
                <input type="number" id="gardenRefillCost" min="0" />
              </div>
              <div class="setting-item">
                <label>åº­åœ’ğŸŒ·APå›å¾©é‡(å…±æœ‰AP)</label>
                <input type="number" id="gardenRefillAmount" min="0" />
              </div>
            </div>
            <div class="setting-item" style="margin-bottom: 15px">
              <label>ãƒãƒ¥ãƒ¼ãƒªãƒƒãƒ—å›å¾©ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ« (æ™‚é–“)</label>
              <input
                type="number"
                id="tulipRefillIntervalHours"
                min="0"
                step="0.5"
              />
              <small style="color: #666"
                >â€»0ã«è¨­å®šã™ã‚‹ã¨å†·å´æ™‚é–“ãªã—ã§é€£ç¶šå›å¾©ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</small
              >
            </div>
          </div>

          <div class="setting-group">
            <div class="setting-item">
              <label>ãƒ©ãƒ³ãƒ€ãƒ è£œå…… (æœ€å°ã€œæœ€å¤§)</label>
              <div style="display: flex; align-items: center; gap: 5px">
                <input type="number" id="randomMin" style="width: 45%" />
                <span>ã€œ</span>
                <input type="number" id="randomMax" style="width: 45%" />
              </div>
            </div>
            <div class="setting-item">
              <label>å¼±å°å‹¢åŠ›ãƒœãƒ¼ãƒŠã‚¹ (æœ€å°ã€œæœ€å¤§)</label>
              <div style="display: flex; align-items: center; gap: 5px">
                <input type="number" id="bonusMin" style="width: 45%" />
                <span>ã€œ</span>
                <input type="number" id="bonusMax" style="width: 45%" />
              </div>
            </div>
          </div>

          <div class="setting-item">
            <label>å…±æœ‰APä¸Šé™ä¿‚æ•° (xã‚¢ã‚¯ãƒ†ã‚£ãƒ–äººæ•°)</label>
            <input type="number" id="sharedBase" min="0" />
          </div>
        </div>

        <div class="section">
          <h3>ğŸ˜ï¸ ãƒãƒ¼ãƒ ãƒ‰ãƒã‚¹è¨­å®š</h3>
          <div class="setting-group">
            <div class="setting-item">
              <label>å»ºè¨­ã‚³ã‚¹ãƒˆ</label>
              <input type="number" id="namedTileCost" min="0" />
            </div>
            <div class="setting-item">
              <label>å»ºé€ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ« (æ™‚é–“)</label>
              <input
                type="number"
                id="namedTileIntervalHours"
                min="0"
                step="0.5"
              />
            </div>
          </div>
          <p style="font-size: 0.8rem; color: #999; margin-top: 5px">
            â€»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’0ã«ã™ã‚‹ã¨é€£ç¶šå»ºè¨­ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
          </p>
        </div>

        <div class="section">
          <h3>âœ‰ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡è¨­å®š</h3>
          <div class="setting-item">
            <label>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚³ã‚¹ãƒˆ (AP)</label>
            <input type="number" id="messageCost" min="0" />
          </div>
        </div>

        <div class="section">
          <h3>ğŸ˜´ ä¼‘æ†©æ™‚é–“è¨­å®š</h3>
          <div
            class="setting-item"
            style="flex-direction: row; align-items: center; gap: 10px"
          >
            <input
              type="checkbox"
              id="breakTimeEnabled"
              style="width: 20px; height: 20px; cursor: pointer"
            />
            <label for="breakTimeEnabled" style="cursor: pointer"
              >ä¼‘æ†©æ™‚é–“ã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼ˆã“ã®é–“ã¯æ”»æ’ƒè¡Œç‚ºãŒã§ãã¾ã›ã‚“ï¼‰</label
            >
          </div>
          <div class="setting-group" style="margin-top: 10px">
            <div class="setting-item">
              <label>é–‹å§‹æ™‚é–“</label>
              <input type="time" id="breakStartTime" value="01:00" />
            </div>
            <div class="setting-item">
              <label>çµ‚äº†æ™‚é–“</label>
              <input type="time" id="breakEndTime" value="06:00" />
            </div>
          </div>
        </div>

        <button class="save-btn" onclick="updateSettings()">
          è¨­å®šã‚’å…¨ã¦ä¿å­˜ã™ã‚‹
        </button>
      </div>

      <!-- ãŠçŸ¥ã‚‰ã›ç®¡ç†ã‚¿ãƒ– -->
      <div id="noticesTab" class="tab-content">
        <div class="section">
          <h3>ç¾åœ¨ã®ãŠçŸ¥ã‚‰ã›</h3>
          <div id="noticeList" class="notice-list">
            <p style="text-align: center; color: #999">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </div>

        <div class="section">
          <h3>ãŠçŸ¥ã‚‰ã›ã‚’è¿½åŠ </h3>
          <div class="setting-item" style="margin-bottom: 10px">
            <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
            <input type="text" id="noticeTitle" placeholder="é‡è¦ãªãŠçŸ¥ã‚‰ã›" />
          </div>
          <div class="setting-item" style="margin-bottom: 15px">
            <label>æœ¬æ–‡</label>
            <textarea
              id="noticeContent"
              rows="4"
              placeholder="å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
            ></textarea>
          </div>
          <button
            class="save-btn"
            style="background-color: var(--primary-color)"
            onclick="addNotice()"
          >
            ğŸ“¢ ãŠçŸ¥ã‚‰ã›ã‚’æŠ•ç¨¿
          </button>
        </div>
      </div>

      <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚¿ãƒ– -->
      <div id="securityTab" class="tab-content">
        <div class="section">
          <h3>ğŸ” ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
          <div class="setting-item" style="margin-bottom: 15px">
            <label>ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input
              type="password"
              id="currentPassword"
              placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
            />
          </div>
          <div class="setting-group">
            <div class="setting-item">
              <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
              <input
                type="password"
                id="newPassword"
                placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
              />
            </div>
            <div class="setting-item">
              <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
              <input
                type="password"
                id="confirmPassword"
                placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›"
              />
            </div>
          </div>
          <button class="save-btn" onclick="changePassword()">
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã™ã‚‹
          </button>
        </div>
      </div>

      <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã‚¿ãƒ– -->
      <div id="accountsTab" class="tab-content">
        <div class="section">
          <h3>ğŸ‘¥ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆåˆ¶é™ (IPãƒ™ãƒ¼ã‚¹)</h3>
          <div class="setting-item">
            <label>åŒä¸€IPã§ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆä¸Šé™</label>
            <input type="number" id="maxAccountsPerIp" min="1" value="2" />
            <small style="color: #666"
              >1ã¤ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ä½œæˆå¯èƒ½ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æœ€å¤§æ•°ã§ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ:
              2ï¼‰ã€‚</small
            >
          </div>
          <div class="setting-item" style="margin-top: 15px">
            <label>åˆ¶é™ã‹ã‚‰é™¤å¤–ã™ã‚‹IPãƒªã‚¹ãƒˆ (æ”¹è¡ŒåŒºåˆ‡ã‚Š)</label>
            <textarea
              id="excludedIps"
              rows="5"
              placeholder="127.0.0.1&#10;192.168.1.1"
            ></textarea>
            <small style="color: #666"
              >ç®¡ç†è€…ã‚„ç‰¹å®šã®ç’°å¢ƒãªã©ã€åˆ¶é™ã‚’é©ç”¨ã—ãŸããªã„IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</small
            >
          </div>
        </div>
        <button class="save-btn" onclick="updateSettings()">
          ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã‚’ä¿å­˜ã™ã‚‹
        </button>
      </div>

      <!-- ãã®ä»–ã‚¿ãƒ– -->
      <div id="othersTab" class="tab-content">
        <div class="section">
          <h3>ğŸ–¼ï¸ ãƒãƒƒãƒ—ç”»åƒè¨­å®š</h3>
          <div class="setting-item">
            <label>ä¿å­˜é–“éš”ï¼ˆåˆ†ï¼‰</label>
            <input type="number" id="mapImageInterval" min="1" max="60" />
            <small style="color: #666"
              >å…¨ä½“ãƒãƒƒãƒ—ç”»åƒã‚’ç”Ÿæˆãƒ»ä¸Šæ›¸ãä¿å­˜ã™ã‚‹é–“éš”ã§ã™ã€‚</small
            >
          </div>
        </div>

        <div class="section">
          <h3>ğŸ†” ãƒ›ã‚¹ãƒˆã®åº­åœ’ ID è¨­å®š</h3>
          <div class="setting-item">
            <label>ãƒ›ã‚¹ãƒˆ ID</label>
            <input type="text" id="adminId" placeholder="ãƒ›ã‚¹ãƒˆ IDã‚’å…¥åŠ›" />
            <small style="color: #666">ğŸŒ·ã®é€ä»˜å…ˆ</small>
          </div>
        </div>

        <button class="save-btn" onclick="updateSettings()">
          è¨­å®šã‚’ä¿å­˜ã™ã‚‹
        </button>

        <!-- å±é™ºãªæ“ä½œ -->
        <details class="danger-zone" style="margin-top: 20px">
          <summary>Danger Zone</summary>
          <div class="danger-content">
            <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px">
              å…¨ã¦ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€å‹¢åŠ›ã€ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
            </p>
            <button class="reset-btn" onclick="resetData()">
              å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
            </button>
          </div>
        </details>
      </div>

      <div id="feedback"></div>
    </div>

    <script>
      let isGameStopped = false;

      // Adminèªè¨¼ãƒã‚§ãƒƒã‚¯
      async function checkAdminAuth() {
        try {
          const res = await fetch("/api/admin/check-auth", {
            credentials: "include",
          });
          if (res.ok) {
            // èªè¨¼æ¸ˆã¿ - Adminç”»é¢ã‚’è¡¨ç¤º
            document.getElementById("adminPanel").style.display = "block";
            document.getElementById("loginModal").style.display = "none";
            await fetchSettings();
          } else {
            // æœªèªè¨¼ - ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById("loginModal").style.display = "flex";
            document.getElementById("adminPanel").style.display = "none";
          }
        } catch (e) {
          document.getElementById("loginModal").style.display = "flex";
          document.getElementById("adminPanel").style.display = "none";
        }
      }

      // Adminãƒ­ã‚°ã‚¤ãƒ³
      async function adminLogin() {
        const password = document.getElementById("loginPassword").value;
        const errorEl = document.getElementById("loginError");

        if (!password) {
          errorEl.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
          return;
        }

        try {
          const res = await fetch("/api/admin/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ password }),
          });

          const data = await res.json();

          if (data.success) {
            document.getElementById("loginPassword").value = "";
            errorEl.textContent = "";
            await checkAdminAuth();
          } else {
            errorEl.textContent = data.error || "ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ";
          }
        } catch (e) {
          errorEl.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
        }
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«èªè¨¼ãƒã‚§ãƒƒã‚¯
      window.addEventListener("DOMContentLoaded", checkAdminAuth);

      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      function switchTab(tabName) {
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));

        if (tabName === "settings") {
          document
            .querySelector(".tab-btn:nth-child(1)")
            .classList.add("active");
          document.getElementById("settingsTab").classList.add("active");
        } else if (tabName === "notices") {
          document
            .querySelector(".tab-btn:nth-child(2)")
            .classList.add("active");
          document.getElementById("noticesTab").classList.add("active");
          fetchNotices(); // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«æœ€æ–°ã®ãŠçŸ¥ã‚‰ã›ã‚’å–å¾—
        } else if (tabName === "security") {
          document
            .querySelector(".tab-btn:nth-child(3)")
            .classList.add("active");
          document.getElementById("securityTab").classList.add("active");
        } else if (tabName === "accounts") {
          document
            .querySelector(".tab-btn:nth-child(4)")
            .classList.add("active");
          document.getElementById("accountsTab").classList.add("active");
        } else if (tabName === "others") {
          document
            .querySelector(".tab-btn:nth-child(5)")
            .classList.add("active");
          document.getElementById("othersTab").classList.add("active");
        }
      }

      function updateUI(data) {
        isGameStopped = data.isGameStopped;
        const gardenMode = data.gardenMode;
        const ap = data.apSettings || {};
        const mapSettings = data.mapImageSettings || {};

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ã®æ›´æ–°
        const statusIcon = document.getElementById("statusIcon");
        const statusText = document.getElementById("statusText");
        const toggleBtn = document.getElementById("toggleBtn");

        if (isGameStopped) {
          statusIcon.textContent = "ğŸ”´";
          statusText.textContent = "ç¾åœ¨: åœæ­¢ä¸­";
          toggleBtn.textContent = "ã‚²ãƒ¼ãƒ ã‚’å†é–‹ã™ã‚‹";
        } else {
          statusIcon.textContent = "ğŸŸ¢";
          statusText.textContent = "ç¾åœ¨: ç¨¼åƒä¸­";
          toggleBtn.textContent = "ã‚²ãƒ¼ãƒ ã‚’åœæ­¢ã™ã‚‹";
        }

        // å„é …ç›®ã®æ›´æ–°
        document.getElementById("gardenMode").checked = !!gardenMode;
        document.getElementById("initialAp").value = ap.initialAp ?? 10;
        document.getElementById("apPerPost").value = ap.apPerPost ?? 10;
        document.getElementById("maxApFromPosts").value =
          ap.maxApFromPosts ?? 10;
        document.getElementById("randomMin").value = ap.random?.min ?? 0;
        document.getElementById("randomMax").value = ap.random?.max ?? 10;
        document.getElementById("bonusMin").value =
          ap.smallFactionBonus?.min ?? 0;
        document.getElementById("bonusMax").value =
          ap.smallFactionBonus?.max ?? 10;
        document.getElementById("indLimit").value = ap.limits?.individual ?? 50;
        document.getElementById("sharedBase").value =
          ap.limits?.sharedBase ?? 50;
        document.getElementById("gardenRefillCost").value =
          ap.gardenRefillCost ?? 30;
        document.getElementById("gardenRefillAmount").value =
          ap.gardenRefillAmount ?? 50;
        document.getElementById("tulipRefillIntervalHours").value =
          ap.tulipRefillIntervalHours ?? 3;
        document.getElementById("messageCost").value = ap.messageCost ?? 5;
        document.getElementById("mapImageInterval").value =
          mapSettings.intervalMinutes ?? 1;

        const ntSettings = data.namedTileSettings || {
          cost: 100,
          intervalHours: 0,
        };
        document.getElementById("namedTileCost").value = ntSettings.cost;
        document.getElementById("namedTileIntervalHours").value =
          ntSettings.intervalHours;

        document.getElementById("adminId").value = data.adminId || "";

        const accounts = data.accountSettings || {};
        document.getElementById("maxAccountsPerIp").value =
          accounts.maxAccountsPerIp ?? 2;
        document.getElementById("excludedIps").value =
          accounts.excludedIps || "";

        // ä¼‘æ†©æ™‚é–“è¨­å®šã®æ›´æ–°
        const breakTime = data.breakTime || {
          enabled: false,
          startTime: "01:00",
          endTime: "06:00",
        };
        document.getElementById("breakTimeEnabled").checked =
          !!breakTime.enabled;
        document.getElementById("breakStartTime").value =
          breakTime.startTime || "01:00";
        document.getElementById("breakEndTime").value =
          breakTime.endTime || "06:00";

        // [NEW] ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«UIã®æ›´æ–°
        updateScheduleUI(data.scheduledAction);

        toggleApPostSettings();
      }

      function updateScheduleUI(action) {
        const statusEl = document.getElementById("scheduleStatus");
        const cancelBtn = document.getElementById("cancelScheduleBtn");
        const scheduleBtn = document.getElementById("scheduleBtn");
        const scheduleTimeInput = document.getElementById("scheduleTime");

        if (action && action.time) {
          const date = new Date(action.time);
          const dateStr = date.toLocaleString("ja-JP", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          });
          statusEl.innerHTML = `<b style="color: #2c3e50;">${action.type === "stop" ? "ğŸ›‘ åœæ­¢" : "ğŸš€ é–‹å§‹"}</b> (${dateStr})`;
          cancelBtn.style.display = "block";
          scheduleBtn.style.display = "none";
          scheduleTimeInput.disabled = true;
          scheduleTimeInput.value = action.time.slice(0, 16); // YYYY-MM-DDTHH:mm
        } else {
          statusEl.textContent = "æœªè¨­å®š";
          cancelBtn.style.display = "none";
          scheduleBtn.style.display = "block";
          scheduleTimeInput.disabled = false;
          scheduleBtn.textContent = isGameStopped ? "é–‹å§‹äºˆç´„" : "åœæ­¢äºˆç´„";
        }
      }

      async function setSchedule() {
        const timeValue = document.getElementById("scheduleTime").value;

        if (!timeValue) {
          showNotify("äºˆç´„æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„", true);
          return;
        }

        const scheduledTime = new Date(timeValue).getTime();
        if (scheduledTime <= Date.now()) {
          showNotify("æœªæ¥ã®æ™‚é–“ã‚’æŒ‡å®šã—ã¦ãã ã•ã„", true);
          return;
        }

        const type = isGameStopped ? "start" : "stop";
        if (
          !confirm(
            `ã‚²ãƒ¼ãƒ ã‚’ ${new Date(timeValue).toLocaleString()} ã«${type === "stop" ? "è‡ªå‹•åœæ­¢" : "è‡ªå‹•é–‹å§‹"}ã™ã‚‹ã‚ˆã†ã«äºˆç´„ã—ã¾ã™ã‹ï¼Ÿ`,
          )
        )
          return;

        try {
          const res = await fetch("/api/admin/settings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
              scheduledAction: {
                type: type,
                time: new Date(timeValue).toISOString(),
              },
            }),
          });
          const data = await res.json();
          if (data.error) {
            showNotify(data.error, true);
          } else {
            showNotify("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’äºˆç´„ã—ã¾ã—ãŸ");
            updateUI(data);
          }
        } catch (e) {
          showNotify("äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸ", true);
        }
      }

      async function cancelSchedule() {
        if (!confirm("ç¾åœ¨ã®äºˆç´„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) return;

        try {
          const res = await fetch("/api/admin/settings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
              scheduledAction: { type: "cancel" },
            }),
          });
          const data = await res.json();
          if (data.error) {
            showNotify(data.error, true);
          } else {
            showNotify("äºˆç´„ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ");
            updateUI(data);
          }
        } catch (e) {
          showNotify("å–ã‚Šæ¶ˆã—ã«å¤±æ•—ã—ã¾ã—ãŸ", true);
        }
      }

      function toggleApPostSettings() {
        const gardenMode = document.getElementById("gardenMode").checked;
        document.getElementById("gardenApSettings").style.display = gardenMode
          ? "block"
          : "none";
      }

      async function fetchSettings() {
        try {
          const res = await fetch("/api/admin/settings");
          const data = await res.json();
          if (data.error) {
            showNotify(data.error, true);
            return;
          }
          updateUI(data);
        } catch (e) {
          showNotify("è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", true);
        }
      }

      async function updateSettings() {
        const settings = {
          gardenMode: document.getElementById("gardenMode").checked,
          apSettings: {
            initialAp: parseInt(document.getElementById("initialAp").value, 10),
            apPerPost: parseInt(document.getElementById("apPerPost").value, 10),
            maxApFromPosts: parseInt(
              document.getElementById("maxApFromPosts").value,
              10,
            ),
            random: {
              min: parseInt(document.getElementById("randomMin").value, 10),
              max: parseInt(document.getElementById("randomMax").value, 10),
            },
            smallFactionBonus: {
              min: parseInt(document.getElementById("bonusMin").value, 10),
              max: parseInt(document.getElementById("bonusMax").value, 10),
            },
            limits: {
              individual: parseInt(
                document.getElementById("indLimit").value,
                10,
              ),
              sharedBase: parseInt(
                document.getElementById("sharedBase").value,
                10,
              ),
            },
            gardenRefillCost: parseInt(
              document.getElementById("gardenRefillCost").value,
              10,
            ),
            gardenRefillAmount: parseInt(
              document.getElementById("gardenRefillAmount").value,
              10,
            ),
            tulipRefillIntervalHours: parseFloat(
              document.getElementById("tulipRefillIntervalHours").value,
            ),
            messageCost: parseInt(
              document.getElementById("messageCost").value,
              10,
            ),
          },
          namedTileSettings: {
            cost: parseInt(document.getElementById("namedTileCost").value, 10),
            intervalHours: parseFloat(
              document.getElementById("namedTileIntervalHours").value,
            ),
          },
          mapImageSettings: {
            intervalMinutes:
              parseInt(document.getElementById("mapImageInterval").value, 10) ||
              1,
          },
          accountSettings: {
            maxAccountsPerIp: parseInt(
              document.getElementById("maxAccountsPerIp").value,
              10,
            ),
            excludedIps: document.getElementById("excludedIps").value.trim(),
          },
          breakTime: {
            enabled: document.getElementById("breakTimeEnabled").checked,
            startTime: document.getElementById("breakStartTime").value,
            endTime: document.getElementById("breakEndTime").value,
          },
          adminId: document.getElementById("adminId").value.trim(),
        };

        try {
          const res = await fetch("/api/admin/settings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(settings),
          });
          const data = await res.json();
          if (data.error) {
            showNotify(data.error, true);
          } else {
            showNotify("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
            updateUI(data);
          }
        } catch (e) {
          showNotify("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ", true);
        }
      }

      async function toggleStatus() {
        const nextState = !isGameStopped;
        const msg = nextState
          ? "ã‚²ãƒ¼ãƒ ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ"
          : "ã‚²ãƒ¼ãƒ ã‚’å†é–‹ã—ã¾ã™ã‹ï¼Ÿ";
        if (!confirm(msg)) return;

        try {
          const res = await fetch("/api/admin/settings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ isGameStopped: nextState }),
          });
          const data = await res.json();
          if (data.error) {
            showNotify(data.error, true);
          } else {
            showNotify("çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
            updateUI(data);
          }
        } catch (e) {
          showNotify("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ", true);
        }
      }

      async function resetData() {
        if (
          !confirm(
            "æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚",
          )
        )
          return;
        if (!confirm("æœ€çµ‚ç¢ºèªã§ã™ã€‚æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

        try {
          const res = await fetch("/api/admin/reset-data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({}),
          });
          const data = await res.json();
          if (data.error) {
            showNotify(data.error, true);
          } else {
            alert(data.message);
            location.reload();
          }
        } catch (e) {
          showNotify("ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ", true);
        }
      }

      // ãŠçŸ¥ã‚‰ã›ç®¡ç†
      async function fetchNotices() {
        try {
          const res = await fetch("/api/notices");
          const data = await res.json();
          const listEl = document.getElementById("noticeList");

          if (!data.notices || data.notices.length === 0) {
            listEl.innerHTML =
              '<p style="text-align: center; color: #999;">ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            return;
          }

          listEl.innerHTML = data.notices
            .filter((n) => n.id && n.id.startsWith("sys-"))
            .map(
              (n) => `
              <div class="notice-item">
                <div class="notice-info">
                  <h4>${escapeHtml(n.title)}</h4>
                  <div style="font-size: 0.9rem;">${escapeHtml(n.content)}</div>
                  <div class="notice-date">${new Date(n.date).toLocaleString()}</div>
                </div>
                <button class="del-notice-btn" onclick="deleteNotice('${n.id}')">å‰Šé™¤</button>
              </div>
            `,
            )
            .join("");
        } catch (e) {
          console.error(e);
        }
      }

      async function addNotice() {
        const title = document.getElementById("noticeTitle").value.trim();
        const content = document.getElementById("noticeContent").value.trim();

        if (!title || !content) {
          showNotify("ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", true);
          return;
        }

        try {
          const res = await fetch("/api/admin/notices", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ title, content }),
          });
          const data = await res.json();
          if (data.error) {
            showNotify(data.error, true);
          } else {
            showNotify("ãŠçŸ¥ã‚‰ã›ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ");
            document.getElementById("noticeTitle").value = "";
            document.getElementById("noticeContent").value = "";
            fetchNotices();
          }
        } catch (e) {
          showNotify("æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ", true);
        }
      }

      async function deleteNotice(id) {
        if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

        try {
          const res = await fetch("/api/admin/notices/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ id }),
          });
          const data = await res.json();
          if (data.error) {
            showNotify(data.error, true);
          } else {
            showNotify("å‰Šé™¤ã—ã¾ã—ãŸ");
            fetchNotices();
          }
        } catch (e) {
          showNotify("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ", true);
        }
      }

      async function changePassword() {
        const currentPassword =
          document.getElementById("currentPassword").value;
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        if (!currentPassword || !newPassword || !confirmPassword) {
          showNotify("å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", true);
          return;
        }
        if (newPassword !== confirmPassword) {
          showNotify("æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“", true);
          return;
        }
        if (newPassword.length < 4) {
          showNotify("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„", true);
          return;
        }

        try {
          const res = await fetch("/api/admin/change-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ currentPassword, newPassword }),
          });
          const data = await res.json();
          if (data.error) {
            showNotify(data.error, true);
          } else {
            showNotify(
              "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§æ“ä½œã—ã¦ãã ã•ã„",
            );
            document.getElementById("password").value = newPassword;
            document.getElementById("currentPassword").value = "";
            document.getElementById("newPassword").value = "";
            document.getElementById("confirmPassword").value = "";
            switchTab("settings");
          }
        } catch (e) {
          showNotify("é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ", true);
        }
      }

      function showNotify(msg, isError = false) {
        const el = document.getElementById("feedback");
        el.textContent = msg;
        el.style.display = "block";
        el.className = isError ? "feedback-error" : "feedback-success";
        setTimeout(() => {
          el.style.display = "none";
        }, 3000);
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // åˆæœŸèª­ã¿è¾¼ã¿
      fetchSettings();
    </script>
  </body>
</html>
